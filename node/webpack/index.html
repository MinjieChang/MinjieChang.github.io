<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简易webpack实现 | 个人主页</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/logo.png">
    <meta name="description" content="常敏杰的博客">
    
    <link rel="preload" href="/assets/css/0.styles.f014b934.css" as="style"><link rel="preload" href="/assets/js/app.73ed0f99.js" as="script"><link rel="preload" href="/assets/js/2.67e34e85.js" as="script"><link rel="preload" href="/assets/js/41.ca70beeb.js" as="script"><link rel="prefetch" href="/assets/js/10.7f540330.js"><link rel="prefetch" href="/assets/js/11.02b60cbf.js"><link rel="prefetch" href="/assets/js/12.12376c9d.js"><link rel="prefetch" href="/assets/js/13.8892aae1.js"><link rel="prefetch" href="/assets/js/14.bbcc7304.js"><link rel="prefetch" href="/assets/js/15.aed58648.js"><link rel="prefetch" href="/assets/js/16.f8080887.js"><link rel="prefetch" href="/assets/js/17.b85e52dc.js"><link rel="prefetch" href="/assets/js/18.ee3504f2.js"><link rel="prefetch" href="/assets/js/19.42c4c61a.js"><link rel="prefetch" href="/assets/js/20.b76090ce.js"><link rel="prefetch" href="/assets/js/21.2eaa853b.js"><link rel="prefetch" href="/assets/js/22.3ff69789.js"><link rel="prefetch" href="/assets/js/23.fd2c35ab.js"><link rel="prefetch" href="/assets/js/24.65c5cce5.js"><link rel="prefetch" href="/assets/js/25.96813b95.js"><link rel="prefetch" href="/assets/js/26.e3322333.js"><link rel="prefetch" href="/assets/js/27.dba65289.js"><link rel="prefetch" href="/assets/js/28.4262c73c.js"><link rel="prefetch" href="/assets/js/29.6a92b436.js"><link rel="prefetch" href="/assets/js/3.d4905b5f.js"><link rel="prefetch" href="/assets/js/30.66e120d6.js"><link rel="prefetch" href="/assets/js/31.08523322.js"><link rel="prefetch" href="/assets/js/32.e28fc3d1.js"><link rel="prefetch" href="/assets/js/33.93b3a069.js"><link rel="prefetch" href="/assets/js/34.86413756.js"><link rel="prefetch" href="/assets/js/35.cea74fba.js"><link rel="prefetch" href="/assets/js/36.1f1fbb43.js"><link rel="prefetch" href="/assets/js/37.568ca527.js"><link rel="prefetch" href="/assets/js/38.36291238.js"><link rel="prefetch" href="/assets/js/39.6655a304.js"><link rel="prefetch" href="/assets/js/4.43d31d04.js"><link rel="prefetch" href="/assets/js/40.2f25a167.js"><link rel="prefetch" href="/assets/js/42.f59133d6.js"><link rel="prefetch" href="/assets/js/43.0c28e9a9.js"><link rel="prefetch" href="/assets/js/44.aa936aaf.js"><link rel="prefetch" href="/assets/js/45.fcb5b21b.js"><link rel="prefetch" href="/assets/js/46.844ece96.js"><link rel="prefetch" href="/assets/js/47.436b41d4.js"><link rel="prefetch" href="/assets/js/48.19700ec8.js"><link rel="prefetch" href="/assets/js/49.75302b25.js"><link rel="prefetch" href="/assets/js/5.53eb6ffc.js"><link rel="prefetch" href="/assets/js/50.adb79790.js"><link rel="prefetch" href="/assets/js/51.d22dc8d7.js"><link rel="prefetch" href="/assets/js/52.816b9e71.js"><link rel="prefetch" href="/assets/js/53.8b5e1175.js"><link rel="prefetch" href="/assets/js/54.7a6d801b.js"><link rel="prefetch" href="/assets/js/6.27411842.js"><link rel="prefetch" href="/assets/js/7.72925e1b.js"><link rel="prefetch" href="/assets/js/8.29780db4.js"><link rel="prefetch" href="/assets/js/9.994f1183.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f014b934.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.zhihu.com/people/jay-55-9/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MinjieChang/myblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.zhihu.com/people/jay-55-9/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MinjieChang/myblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>designPattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/koa2/" class="sidebar-link">koa2 中间件的实现分析及实现自己的中间件组合方式</a></li><li><a href="/node/module/" class="sidebar-link">import、export，require、exports模块化分析</a></li><li><a href="/node/babel/" class="sidebar-link">babel 解析</a></li><li><a href="/node/babel-plugin-console-omit/" class="sidebar-link">babel-plugin-console-omit</a></li><li><a href="/node/babel-plugin-lodash-import/" class="sidebar-link">babel-plugin-lodash-import</a></li><li><a href="/node/webpack/" aria-current="page" class="active sidebar-link">简易webpack实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/webpack/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/node/webpack/#实现" class="sidebar-link">实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/webpack/#添加配置文件" class="sidebar-link">添加配置文件</a></li><li class="sidebar-sub-header"><a href="/node/webpack/#解析入口文件" class="sidebar-link">解析入口文件</a></li><li class="sidebar-sub-header"><a href="/node/webpack/#解析依赖文件" class="sidebar-link">解析依赖文件</a></li><li class="sidebar-sub-header"><a href="/node/webpack/#生成运行文件" class="sidebar-link">生成运行文件</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/webpack/#添加loader" class="sidebar-link">添加loader</a></li><li class="sidebar-sub-header"><a href="/node/webpack/#使用cli" class="sidebar-link">使用cli</a></li></ul></li><li><a href="/node/webpack-lazy/" class="sidebar-link">webpack 异步加载</a></li><li><a href="/node/devServer-mock/" class="sidebar-link">基于 webpack-dev-server 搭建 mock 服务</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>helpers</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="简易webpack实现"><a href="#简易webpack实现" class="header-anchor">#</a> 简易webpack实现</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>结合 <code>babel</code> 的解析能力，模拟实现 <code>webpack</code> 的核心模块加载功能</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>首先新建一个项目，目录结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── src
│   ├── compiler<span class="token punctuation">.</span>js
│   ├── index<span class="token punctuation">.</span>js
│   ├── parser<span class="token punctuation">.</span>js
├── test
│   ├── a<span class="token punctuation">.</span>js
│   ├── b<span class="token punctuation">.</span>js
│   ├── c<span class="token punctuation">.</span>js
│   └── index<span class="token punctuation">.</span>js
└── webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js
</code></pre></div><h3 id="添加配置文件"><a href="#添加配置文件" class="header-anchor">#</a> 添加配置文件</h3> <p>首先添加上 <code>webpack.config.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./test/index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'main.js'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 <code>./test/index.js</code> 是测试文件，可以看成是我们的 <code>webpack</code>要打包的项目的入口文件</p> <p><code>src/index.js</code>是我们的 <code>webpack</code> 的入口文件，这个文件主要是实例一个 <code>Compiler</code>对象并触发编译方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./compiler'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../webpack.config'</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="解析入口文件"><a href="#解析入口文件" class="header-anchor">#</a> 解析入口文件</h3> <p>现在来看 <code>compiler</code>文件，首先要做的是解析入口文件，从解析的结果中拿到入口文件的依赖项：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> output <span class="token punctuation">}</span> <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>entry <span class="token operator">=</span> entry
    <span class="token keyword">this</span><span class="token punctuation">.</span>output <span class="token operator">=</span> output
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依赖收集</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModules</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">buildModules</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parser</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token function">getModuleDependences</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
      code<span class="token punctuation">,</span>
      filename<span class="token punctuation">,</span>
      dependencies<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么如何解析入口文件，如何拿到入口文件的依赖？这里就需要使用 <code>babel</code>提供的能力了。关于 <code>babel</code>如何解析文件可以参考<a href="https://minjiechang.github.io/node/babel/" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>解析过程中使用到了三个方法：</p> <ol><li>parser：将文件解析成 <code>ast</code></li> <li>getModuleDependences：收集文件依赖</li> <li>transform：将 <code>es6</code>文件转化为 <code>es5</code></li></ol> <p>这几个方法统一放在了 <code>src/parser.js</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;babel-core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babelParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> babelTraverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> babelGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/generator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">parser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> babelParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token operator">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">getModuleDependences</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ast</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">ImportDeclaration</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token function">babelTraverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">)</span>
  <span class="token keyword">return</span> dependencies
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">transform</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对 <code>babel</code>比较了解的话，这几个方法还是很容易理解的，不了解的话可以参考<a href="https://minjiechang.github.io/node/babel/" target="_blank" rel="noopener noreferrer">这篇文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>最终在 <code>buildModules</code>方法中返回了一个对象：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>
  code<span class="token punctuation">,</span>
  filename<span class="token punctuation">,</span>
  dependencies<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> result
</code></pre></div><p>其中 <code>code</code>代表解析成 <code>es5</code>格式的文件内容，<code>filename</code>表示文件名称，这里使用的绝对路径表示；<code>dependencies</code>表示文件的依赖项，结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  code<span class="token operator">:</span> <span class="token string">'use strict;'</span><span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">&quot;var _a = require('./a.js');\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'var _a2 = _interopRequireDefault(_a);\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">&quot;var _c = require('./c.js');\n&quot;</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'var _c2 = _interopRequireDefault(_c);\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }\n'</span> <span class="token operator">+</span>
    <span class="token string">'\n'</span> <span class="token operator">+</span>
    <span class="token string">'console.log(_c2.default);\n'</span> <span class="token operator">+</span>
    <span class="token string">'(0, _a2.default)();'</span><span class="token punctuation">,</span>
  filename<span class="token operator">:</span> <span class="token string">&quot;/Users/chang/Desktop/simply-webpack/test/index.js&quot;</span><span class="token punctuation">,</span>
  dependencies<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./a.js'</span><span class="token punctuation">,</span> <span class="token string">'./c.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="解析依赖文件"><a href="#解析依赖文件" class="header-anchor">#</a> 解析依赖文件</h3> <p>现在得到了入口文件的编译后文件及其依赖文件，但是仅仅知道了依赖的文件还不够，还需要找到依赖的文件的内容及依赖文件的依赖，这么说有点绕，实际上就是还需要再递归解析依赖文件而已：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依赖收集</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModules</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> module <span class="token operator">=</span> modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> filename<span class="token punctuation">,</span> dependencies <span class="token punctuation">}</span> <span class="token operator">=</span> module
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        module<span class="token punctuation">.</span>dependencieMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dependencie</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> dependenciePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> dependencie<span class="token punctuation">)</span>
          module<span class="token punctuation">.</span>dependencieMap<span class="token punctuation">[</span>dependencie<span class="token punctuation">]</span> <span class="token operator">=</span> dependenciePath
          modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModules</span><span class="token punctuation">(</span>dependenciePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> modules
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码中定义了一个 <code>modules</code>变量，从入口模块开始遍历，遍历模块的依赖再执行 <code>buildModules</code>操作：</p> <div class="language-js extra-class"><pre class="language-js"><code>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModules</span><span class="token punctuation">(</span>dependenciePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这里使用push的方式往modules中加入新的模块，这种递归使用的<strong>广度优先</strong>的方式，此处使用广度优先相对深度优先更合理，防止在递归层级较深的情况下栈溢出的情况</p> <p>在遍历的过程中有这么一条语句：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>dependencieMap<span class="token punctuation">[</span>dependencie<span class="token punctuation">]</span> <span class="token operator">=</span> dependenciePath
</code></pre></div><p>这是为了将文件中依赖的相对路径指向真实的文件路径，方便在模块中执行 <code>require</code>时候有对应的路径映射，这在后面会讲到</p> <p>处理后最终得到的 modules 结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    code<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'/Users/chang/Desktop/simply-webpack/test/index.js'</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'./a.js'</span><span class="token punctuation">,</span> <span class="token string">'./c.js'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    dependencieMap<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'./a.js'</span><span class="token operator">:</span> <span class="token string">'/Users/chang/Desktop/simply-webpack/test/a.js'</span><span class="token punctuation">,</span>
      <span class="token string">'./c.js'</span><span class="token operator">:</span> <span class="token string">'/Users/chang/Desktop/simply-webpack/test/c.js'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

</code></pre></div><h3 id="生成运行文件"><a href="#生成运行文件" class="header-anchor">#</a> 生成运行文件</h3> <p>在 <code>run</code>方法中，我们最终得到了包含所有模块内容的 <code>modules</code>数组。现在如何将这些模块代码组织并运行起来？查看编译后的文件，我们发现，有模块导入导出的文件都包含 <code>require</code>和 <code>exports</code>变量，所以需要向编译的代码中注入这两个变量。</p> <p>首先将 <code>modules</code>转换一下，转换成文件名称对文件内容映射的关系：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      modules<span class="token punctuation">[</span>module<span class="token punctuation">.</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        code<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function fn(module, require, exports){</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        dependencieMap<span class="token operator">:</span> module<span class="token punctuation">.</span>dependencieMap
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时，将模块转换得到的 <code>code</code> 包裹到了一个函数中，并传入 <code>module, require, exports</code> 三个变量。</p> <p>现在的主要点在于实现 <code>require</code>方法，使代码能跑起来：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> entry <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entry<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">rawRequire</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
      exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> dependencieMap <span class="token punctuation">}</span> <span class="token operator">=</span> modules<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">rawRequire</span><span class="token punctuation">(</span>dependencieMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> codeFn <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;(false || &quot;</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">codeFn</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">rawRequire</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">start</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span>
</code></pre></div><p>这里定义了一个 <code>start</code>方法并传入上面转换得到的<code>modules</code>，在此方法中主要做了这几件事：</p> <ol><li>定义 <code>rawRequire</code>方法，初始下传入入口文件名称调用</li> <li><code>rawRequire</code> 方法中定义了 <code>module</code> 变量，这里的 module 实际上就是个对象，并且包含了 <code>exports</code>属性，该属性值同样也是个对象</li> <li>根据传入的path路径取出对应的模块，以及模块中的 <code>code</code>和 <code>dependencieMap</code></li> <li>定义 <code>require</code> 方法，注意在此项目中实际的require传入的是相对路径，所以需要对路径做一下转换，转化成实际的文件路径再给 <code>rawRequire</code>执行， <code>rawRequire(dependencieMap[path])</code></li> <li>使用 <code>eval</code>解析出代码，并传入 <code>module, require, module.exports</code>变量</li> <li>最后一定要返回模块的导出结果，这是引入的模块最终使用 <code>require</code>得到的结果</li></ol> <p>最终，我们可以完整的将代码 <code>run</code>起来了！！</p> <p>还有最后一步，类似webpack的做法，需要把打包的代码导出到一个文件中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token operator">:</span> outputPath<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>output
    <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      (function (modules) {
        function rawRequire(path) {
          const module = {
            exports: {}
          }
          const { code, dependencieMap } = modules[path]
          console.log(dependencieMap, 'dependencieMap');
          let require = (path) =&gt; {
            return rawRequire(dependencieMap[path])
          }
          let codeFn = eval(&quot;(false || &quot; + code + &quot;)&quot;);
          codeFn(module, require, module.exports)
          return module.exports
        }
        return rawRequire('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entry<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')
      })(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    </span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="添加loader"><a href="#添加loader" class="header-anchor">#</a> 添加loader</h2> <p>webapack在解析文件的时候会使用到对应的 <code>loader</code>，譬如在解析js文件的时候会使用到 <code>babel-loader</code>，同时也可以添加对应的 <code>babel-plugin</code>，比如在 <code>webpack.config.js</code>中添加如下配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        includes<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">test\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'console-omit'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>env<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lodash-import'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们的目标是，在解析 <code>test</code>目录下的js文件需要使用到两个插件 <a href="https://www.npmjs.com/package/babel-plugin-console-omit" target="_blank" rel="noopener noreferrer">babel-plugin-console-omit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://www.npmjs.com/package/babel-plugin-lodash-import" target="_blank" rel="noopener noreferrer">babel-plugin-lodash-import<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，现在看如何将这些插件使用到代码的解析中</p> <p>在 <code>buildModules</code>中添加如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token function">buildModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> ast
    <span class="token keyword">let</span> dependencies
    <span class="token keyword">let</span> code

    <span class="token keyword">let</span> usePlugins <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> usePresets <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">rule</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// node_modules 下的文件不需要加上插件和presets</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span>includes <span class="token operator">&amp;&amp;</span> rule<span class="token punctuation">.</span>includes<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rule<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">test</span>         <span class="token punctuation">(</span><span class="token function">addFileNameSuffix</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> rule<span class="token punctuation">.</span>excludes <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>rule<span class="token punctuation">.</span>excludes<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rule<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token function">addFileNameSuffix</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        usePlugins <span class="token operator">=</span> <span class="token boolean">true</span>
        usePresets <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将配置中的插件传入解析方法中</span>
      ast <span class="token operator">=</span> <span class="token function">transformWithPlugins</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> usePlugins<span class="token punctuation">,</span> rule<span class="token punctuation">.</span>use<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">.</span>ast
      dependencies <span class="token operator">=</span> <span class="token function">getModuleDependences</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
      code <span class="token operator">=</span> <span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> usePresets<span class="token punctuation">)</span><span class="token punctuation">.</span>code
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实际上就是判断在解析文件时符合配置文件中的rule规则时，就使用插件解析文件，然后修改解析的方法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">transformWithPlugins</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> usePlugins<span class="token punctuation">,</span> plugins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    plugins<span class="token operator">:</span> usePlugins <span class="token operator">?</span> plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">transformFromAst</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> usePresets</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    presets<span class="token operator">:</span> usePresets <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">'env'</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时再打包后发现，src/index解析后的文件中的 <code>console</code>语句都去掉了，说明我们添加的 <code>console-omit</code>插件已经生效了。</p> <p>当然在这里我们对配置文件中传入的插件的格式没有做处理，主要是这里的插件的格式是按照 <code>babel</code>需要的格式提供的。</p> <h2 id="使用cli"><a href="#使用cli" class="header-anchor">#</a> 使用cli</h2> <p>在此项目中，我们执行打包是使用的 <code>package.json</code>中的命令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel-node src/index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是，正常的 <code>webapck</code>的打包是使用的webpack命令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config webpack.config.js&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>下面，把项目改造成使用命令的方式</p> <p>首先在 <code>simply-webpack</code>项目 <code>package.json</code>文件中添加 <code>bin</code> 字段：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;simply-webpack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里需要注意的是，在打包发布后需要把 <code>src/index.js</code>修改为 <code>lib/index.js</code></p> <p>然后需要在 <code>src/index.js</code>文件头部添加上如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token operator">...</span>
</code></pre></div><p>表明该文件需要使用 <code>node</code>执行</p> <p>为了测试我们的 <code>simply-webpack</code> 的命令是否有效，我们还需要在本地再新建一个项目 <code>simply-webpack-test</code>，然后把 <code>simply-webpack</code>的 <code>test</code>目录和 <code>webpack.dev.js</code>拷贝到 <code>simply-webpack-test</code> 项目中，目录如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>├── dist
│   ├── index<span class="token punctuation">.</span>html
│   └── main<span class="token punctuation">.</span>js
├── <span class="token keyword">package</span><span class="token operator">-</span>lock<span class="token punctuation">.</span>json
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
├── test
│   ├── a<span class="token punctuation">.</span>js
│   ├── b<span class="token punctuation">.</span>js
│   ├── c<span class="token punctuation">.</span>js
│   └── index<span class="token punctuation">.</span>js
└── webpack<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>js
</code></pre></div><p>两个项目建好了，那如何在<code>simply-webpack-test</code>项目中调试呢？</p> <p>这里需要使用 <code>npm link</code>的方式，将 <code>simply-webpack</code>映射到全局，然后再在<code>simply-webpack-test</code>中关联到全局的 <code>simply-webpack</code>即可。</p> <ol><li>在 <code>simply-webpack</code>中执行：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npm link
</code></pre></div><ol start="2"><li>在 <code>simply-webpack-test</code>中执行：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npm link simply<span class="token operator">-</span>webpack
</code></pre></div><ol start="3"><li>在 <code>simply-webpack-test</code>的 <code>package.json</code> 中添加脚本：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;simply-webpack --config webpack.dev.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后可以在 <code>simply-webpack</code>中修改代码，在<code>simply-webpack-test</code>中执行 <code>build</code>命令即可调试了</p> <p>完整项目地址<a href="https://github.com/MinjieChang/simply-webpack" target="_blank" rel="noopener noreferrer">点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">7/5/2021, 2:47:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node/babel-plugin-lodash-import/" class="prev">
        babel-plugin-lodash-import
      </a></span> <span class="next"><a href="/node/webpack-lazy/">
        webpack 异步加载
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.73ed0f99.js" defer></script><script src="/assets/js/2.67e34e85.js" defer></script><script src="/assets/js/41.ca70beeb.js" defer></script>
  </body>
</html>
