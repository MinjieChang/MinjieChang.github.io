<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>import、export，require、exports模块化分析 | 个人主页</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/img/logo.ico">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/logo.png">
    <meta name="description" content="常敏杰的博客">
    
    <link rel="preload" href="/assets/css/0.styles.f014b934.css" as="style"><link rel="preload" href="/assets/js/app.73ed0f99.js" as="script"><link rel="preload" href="/assets/js/2.67e34e85.js" as="script"><link rel="preload" href="/assets/js/17.b85e52dc.js" as="script"><link rel="prefetch" href="/assets/js/10.7f540330.js"><link rel="prefetch" href="/assets/js/11.02b60cbf.js"><link rel="prefetch" href="/assets/js/12.12376c9d.js"><link rel="prefetch" href="/assets/js/13.8892aae1.js"><link rel="prefetch" href="/assets/js/14.bbcc7304.js"><link rel="prefetch" href="/assets/js/15.aed58648.js"><link rel="prefetch" href="/assets/js/16.f8080887.js"><link rel="prefetch" href="/assets/js/18.ee3504f2.js"><link rel="prefetch" href="/assets/js/19.42c4c61a.js"><link rel="prefetch" href="/assets/js/20.b76090ce.js"><link rel="prefetch" href="/assets/js/21.2eaa853b.js"><link rel="prefetch" href="/assets/js/22.3ff69789.js"><link rel="prefetch" href="/assets/js/23.fd2c35ab.js"><link rel="prefetch" href="/assets/js/24.65c5cce5.js"><link rel="prefetch" href="/assets/js/25.96813b95.js"><link rel="prefetch" href="/assets/js/26.e3322333.js"><link rel="prefetch" href="/assets/js/27.dba65289.js"><link rel="prefetch" href="/assets/js/28.4262c73c.js"><link rel="prefetch" href="/assets/js/29.6a92b436.js"><link rel="prefetch" href="/assets/js/3.d4905b5f.js"><link rel="prefetch" href="/assets/js/30.66e120d6.js"><link rel="prefetch" href="/assets/js/31.08523322.js"><link rel="prefetch" href="/assets/js/32.e28fc3d1.js"><link rel="prefetch" href="/assets/js/33.93b3a069.js"><link rel="prefetch" href="/assets/js/34.86413756.js"><link rel="prefetch" href="/assets/js/35.cea74fba.js"><link rel="prefetch" href="/assets/js/36.1f1fbb43.js"><link rel="prefetch" href="/assets/js/37.568ca527.js"><link rel="prefetch" href="/assets/js/38.36291238.js"><link rel="prefetch" href="/assets/js/39.6655a304.js"><link rel="prefetch" href="/assets/js/4.43d31d04.js"><link rel="prefetch" href="/assets/js/40.2f25a167.js"><link rel="prefetch" href="/assets/js/41.ca70beeb.js"><link rel="prefetch" href="/assets/js/42.f59133d6.js"><link rel="prefetch" href="/assets/js/43.0c28e9a9.js"><link rel="prefetch" href="/assets/js/44.aa936aaf.js"><link rel="prefetch" href="/assets/js/45.fcb5b21b.js"><link rel="prefetch" href="/assets/js/46.844ece96.js"><link rel="prefetch" href="/assets/js/47.436b41d4.js"><link rel="prefetch" href="/assets/js/48.19700ec8.js"><link rel="prefetch" href="/assets/js/49.75302b25.js"><link rel="prefetch" href="/assets/js/5.53eb6ffc.js"><link rel="prefetch" href="/assets/js/50.adb79790.js"><link rel="prefetch" href="/assets/js/51.d22dc8d7.js"><link rel="prefetch" href="/assets/js/52.816b9e71.js"><link rel="prefetch" href="/assets/js/53.8b5e1175.js"><link rel="prefetch" href="/assets/js/54.7a6d801b.js"><link rel="prefetch" href="/assets/js/6.27411842.js"><link rel="prefetch" href="/assets/js/7.72925e1b.js"><link rel="prefetch" href="/assets/js/8.29780db4.js"><link rel="prefetch" href="/assets/js/9.994f1183.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f014b934.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.zhihu.com/people/jay-55-9/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MinjieChang/myblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/recent/" class="nav-link">
  最新文章
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link">
  css
</a></li></ul></div></div><div class="nav-item"><a href="/node/" class="nav-link router-link-active">
  node
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://www.zhihu.com/people/jay-55-9/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  知乎
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/MinjieChang/myblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">目录</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>designPattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node/koa2/" class="sidebar-link">koa2 中间件的实现分析及实现自己的中间件组合方式</a></li><li><a href="/node/module/" aria-current="page" class="active sidebar-link">import、export，require、exports模块化分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/module/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/node/module/#babel-模块实现" class="sidebar-link">babel 模块实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/module/#babel编译导出" class="sidebar-link">babel编译导出</a></li><li class="sidebar-sub-header"><a href="/node/module/#babel编译默认导入" class="sidebar-link">babel编译默认导入</a></li><li class="sidebar-sub-header"><a href="/node/module/#babel编译全量导入" class="sidebar-link">babel编译全量导入</a></li><li class="sidebar-sub-header"><a href="/node/module/#babel编译变量导入" class="sidebar-link">babel编译变量导入</a></li><li class="sidebar-sub-header"><a href="/node/module/#require-导入" class="sidebar-link">require 导入</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/module/#webpack-模块化的原理" class="sidebar-link">webpack 模块化的原理</a></li><li class="sidebar-sub-header"><a href="/node/module/#webpack-和-babel-模块化的配合" class="sidebar-link">webpack 和 babel 模块化的配合</a></li><li class="sidebar-sub-header"><a href="/node/module/#模块依赖优化" class="sidebar-link">模块依赖优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/module/#tree-shaking" class="sidebar-link">tree shaking</a></li><li class="sidebar-sub-header"><a href="/node/module/#按需加载" class="sidebar-link">按需加载</a></li></ul></li><li class="sidebar-sub-header"><a href="/node/module/#webpack编译后再导出供三方使用" class="sidebar-link">webpack编译后再导出供三方使用</a></li><li class="sidebar-sub-header"><a href="/node/module/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/node/babel/" class="sidebar-link">babel 解析</a></li><li><a href="/node/babel-plugin-console-omit/" class="sidebar-link">babel-plugin-console-omit</a></li><li><a href="/node/babel-plugin-lodash-import/" class="sidebar-link">babel-plugin-lodash-import</a></li><li><a href="/node/webpack/" class="sidebar-link">简易webpack实现</a></li><li><a href="/node/webpack-lazy/" class="sidebar-link">webpack 异步加载</a></li><li><a href="/node/devServer-mock/" class="sidebar-link">基于 webpack-dev-server 搭建 mock 服务</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>helpers</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="import、export-require、exports模块化分析"><a href="#import、export-require、exports模块化分析" class="header-anchor">#</a> import、export，require、exports模块化分析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在使用<code>antd</code>组件的过程中，发现在其库中经过编译后的代码是这样的形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> _button <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;antd/lib/button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

</code></pre></div><p>在编译后的文件中加上了 <code>_interopRequireDefault</code> 这个函数，该函数的逻辑也很简单，判断 <code>obj</code>参数时候有 <code>__esModule</code>属性，有就返回该对象，没有就返回包装过的新对象 <code>{ default: obj }</code>，这个函数是babel编译加上的，那babel为什么要这么做呢？</p> <p>带着这个问题，本文试着来解析一下 <code>babel</code> 在解析模块化语句中做了哪些事情。</p> <p>目前前端模块化，常用的就是 <code>commonjs</code> 的 <code>require</code>、<code>exports</code>实现的模块化，及 <code>es6</code>实现的 <code>import</code>、<code>export</code>导入导出的方式，并且对于模块化的实现，<code>webpack</code>和 <code>babel</code>都有自己的方式，现在我们分别看一下他们各自如何实现的。</p> <h2 id="babel-模块实现"><a href="#babel-模块实现" class="header-anchor">#</a> babel 模块实现</h2> <p>babel可以看成是 <code>javascript</code>语法的编译器，用来将 <code>es6</code>的语法翻译成 <code>es5</code>的语法，这也包括对于est6的模块化语法的转换。</p> <p>在看之前，这里先抛出几个问题帮助我们思考babel做的工作</p> <ol><li><strong>babel将es6的导入导出语法转换成了什么？</strong></li> <li><strong>es6的导入导出有多种写法，bable是如何处理这些不同的情况的？</strong></li> <li><strong>为什么使用require的方式导入一些文件需要加上 <code>default</code>, 而有的导入就不需要呢？</strong></li></ol> <p>这里通过起一个小项目来解析这些问题。项目地址可以在<a href="https://github.com/MinjieChang/module" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看</p> <p>首先起一个项目并安装babel编译环境：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i babel-cli babel-preset-es2015 -D
</code></pre></div><h3 id="babel编译导出"><a href="#babel编译导出" class="header-anchor">#</a> babel编译导出</h3> <p>定义 <code>a.js</code> 文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> b<span class="token punctuation">,</span> c <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">123</span><span class="token punctuation">;</span>
</code></pre></div><p>在 <code>a.js</code> 中，使用es6的语法，导出了三个变量，及一个默认default导出，使用babel先编译下 <code>a.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;build_export&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel a.js -o compiledA.js&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>输出结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>
</code></pre></div><p>可以看出，<strong>babel将es6的导入导出语句转换成了commonjs的写法了</strong>，需要注意的是，将es6的默认输出 <code>export default</code> 挂载到了 commonjs的 <code>exports.default</code>变量上，并且在 <code>exports</code> 上定义了 <code>__esModule</code> 属性，表面此文件导出的是es6的模块</p> <h3 id="babel编译默认导入"><a href="#babel编译默认导入" class="header-anchor">#</a> babel编译默认导入</h3> <p>然后再定义 <code>index.js</code>，并在此文件中引入 <code>a.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'a.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>编译 <code>index.js</code> 结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _a2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token string">'a.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_a2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以发现，编译后的文件和在文章开始给出的代码很像，那为何babel要引入 <code>_interopRequireDefault</code> 这个函数，加工一下我们 <code>require</code> 的内容呢？然后最终引用的是 <code>_a2.default</code>呢？，这是由于：</p> <ul><li>es6的 <code>import a from './a.js';</code>，本意是要引入 <code>a.js</code>的默认输出即 <code>export default</code>，bable转换后变成了 <code>var _a = require('./a.js');</code>，对于原始的es6模块，使用babel编译后 <code>export default</code>的输出被挂载到了 <code>exports.default</code>上，而使用 <code>require</code>导入的是整个 <code>exporst</code>对象，所以导入需要加上 <code>default</code>字段；而对于原始的 <code>commonjs</code>模块，由于模块中没有输出 <code>default</code>属性，所以需要将原始的输出 <code>exports</code>对象复制给一个新对象的 <code>default</code>属性，然后再导出，这个过程也就是 <code>_interopRequireDefault</code> 辅助函数做的事情。</li></ul> <h3 id="babel编译全量导入"><a href="#babel编译全量导入" class="header-anchor">#</a> babel编译全量导入</h3> <p>对于es6的 <code>import * as a from 'xxx'</code>导入方式，本意是要引入es6模块的所有命名输出包括 <code>default</code>输出打包成一个对象赋值给 <code>a</code>属性，对于这种情况，当我们在引入一个es6模块和commonjs模块的时候，babel是如何做的呢？</p> <p>使用babel编译如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> a <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre></div><p>得到的结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./a.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">_interopRequireWildcard</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_interopRequireWildcard</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
          newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    newObj<span class="token punctuation">.</span>default <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> newObj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们发现此时多了一个 <code>_interopRequireWildcard</code> 辅助函数，这个函数主要对模块类型做了判断：</p> <ul><li>通过 <code>obj.__esModule</code>判断模块是否为es6模块，如果是，直接返回该模块</li> <li>否则如果不是es6模块，那么会把模块内的所有具名导出赋值给一个新的对象 <code>newObj</code>，最后再把原始对象 <code>obj</code>赋值给新对象 <code>newObj</code>的 <code>default</code>属性，最终返回此新对象。</li></ul> <p>对这两种情况我们尝试分析一下：</p> <ul><li><p><code>import * as a from './a.js';</code> 要导入模块的全部输出。对于es6模块，babel编译后已经包含了所有的具名输出和 <code>default</code>输出：</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>
</code></pre></div><p>这种输出方式符合了es6这种导入方式的意图，所以直接返回原始模块即可。</p></li> <li><p>对于commonjs模块，模块已经输出了所有具名属性，只是没有输出 <strong>default</strong> 属性，所以babel的处理方式就是把模块的整体输出赋值给一个新对象的default属性，<code>newObj.default = obj;</code> 。</p></li></ul> <h3 id="babel编译变量导入"><a href="#babel编译变量导入" class="header-anchor">#</a> babel编译变量导入</h3> <p>es6的导入代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
</code></pre></div><p>这种方式从引入的模块中导入三个变量，babel编译的结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_a<span class="token punctuation">.</span>a<span class="token punctuation">,</span> _a<span class="token punctuation">.</span>b<span class="token punctuation">,</span> _a<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>由于 <code>require</code>加载的是整个 <code>exports</code>对象，babel没有做特殊的转换，只需要获取对应的属性即可</p> <p>以上三种导入方式基本上涵盖了es6的常用导入方式，这也基本上回答了上面提出的<a href="#babel-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0">问题2</a>。</p> <h3 id="require-导入"><a href="#require-导入" class="header-anchor">#</a> require 导入</h3> <p>commonjs的导入使用 <code>require</code> 方式，但是我们通常会碰到在 <code>require</code>一些模块的时候需要加上 <strong>default</strong>，有的时候又不需要加上，这是为什么呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> babylon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
</code></pre></div><p><strong>通常这种情况出现于使用require的方式导入es6的模块</strong>，由于es6的 <code>export default xxx</code> 会被编译成 <code>exports.default = xxx</code>，所以使用 require 的方式导入需要加上 <code>require(xxx).default</code></p> <p>而使用 es6 的import导入不需要加上default，这是由于babel在编译es6导入的时候会加上 <code>_interopRequireDefault</code> 这个辅助方法，对于引入的es6或commonjs模块都加上了 <code>default</code> 属性</p> <p>这个场景通常会在写 webpack 代码分割逻辑时经常会遇到。</p> <div class="language-js extra-class"><pre class="language-js"><code>require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">require</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/pages/profitList'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>实际上，这是babel6之后做的变更，在babel5中可不是这样的：</p> <p><img src="/assets/img/50f3e48e-940f-40c8-85eb-5ee2f6f85dfe.29323bdc.png" alt="alt"></p> <p>在babel5时代，开发者使用require引入es6的模块的default输出，习惯性的认为require进来的就是模块的默认输出，所以babel5对这个逻辑做了hack处理，当一个模块中只有default输出的情况下，babel5会将模块的默认输出赋值给 <code>module.exports</code> 对象，也就是导入的全部内容就是模块的default输出了，这样，在我们require一个es6模块的时候就不需要加上default属性了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token keyword">default</span> <span class="token operator">=</span> exports<span class="token punctuation">.</span>default
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">default</span>
</code></pre></div><p>这样的一个问题是，这么hack的方式其实是不符合es6的本意的，es6中default输出其实也只是输出的一个default变量，和普通的变量输出没有区别</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'a'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token string">'b'</span>

<span class="token comment">// 引入</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> a<span class="token punctuation">,</span> b <span class="token punctuation">}</span>
</code></pre></div><p>还有一个潜在的问题是，在一个本来只有默认输出的模块中，再加上输出其他的具名变量，这样就会导致引入的结果发生变化：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'a'</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token string">'b'</span> <span class="token comment">// 新增</span>
</code></pre></div><p>引入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span> <span class="token punctuation">)</span>

<span class="token comment">// 之前的引入结果是 ‘a’</span>
<span class="token comment">// 现在的引入结果变为 { default: 'a', b: 'b' }</span>
</code></pre></div><p>所以在babel6中就去掉了这个hack方法，所以在使用require导入es6的默认输出的时候需要加上default属性。如果你觉得加上比较麻烦，可以引入 <strong>babel-plugin-add-module-exports</strong> 这个插件即可。</p> <p>这也就回答了上面提到的<a href="#babel-%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0">问题3</a></p> <p>以上是对babel模块化解析的部分，相信看到这里的你应该对es6和commonjs的模块混用的原理有了一定的认识了。</p> <p>这部分的代码可在<a href="https://github.com/MinjieChang/module/tree/master/babel-module" target="_blank" rel="noopener noreferrer">这里查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="webpack-模块化的原理"><a href="#webpack-模块化的原理" class="header-anchor">#</a> webpack 模块化的原理</h2> <p>webpack在进行打包的过程中对于模块化的解析也是实现了自己的一套方式。这里以webpack3为例，首先安装webpack并添加配置文件如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>index.js的文件如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> a <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'index.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>a.js的文件如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span>
</code></pre></div><p>使用webpack打包后得到的结果如下，这里省略了部分代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// The require function</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a new module (and put it into the cache)</span>
    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      i<span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
      l<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute the module function</span>
    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return the exports of the module</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Load entry module and return exports</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token comment">/* 0 */</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__a_js__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__WEBPACK_IMPORTED_MODULE_0__a_js__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* 1 */</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

      __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到打包后得到的是个自执行函数，分别来解析函数体和参数部分，先来看函数体内。</p> <p>在函数内部定义了 <code>__webpack_require__</code>函数，这个函数就是webpack用于导入模块的方法，先看看这个函数干了什么事情。</p> <ol><li>在函数内定义了module对象，及定义了值为对象的exports属性</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> i<span class="token operator">:</span> moduleId<span class="token punctuation">,</span> l<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>接着执行对应的模块方法，并传入三个参数</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// modules[moduleId] 表示从参数中取出对应的模块</span>
<span class="token comment">// 再传入 module, module.exports, __webpack_require__ 这三个参数</span>
</code></pre></div><ol start="3"><li>最后再把 <code>module.exports</code> 返回出去。</li></ol> <p>以上是 <strong>webpack_require</strong> 内部的过程。</p> <p>在自执行的函数体内执行了 <code>__webpack_require__(0)</code>，并且传入的参数是0，此时相当于执行</p> <div class="language-js extra-class"><pre class="language-js"><code>modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看完了函数体内的部分，再看自执行函数的参数部分。</p> <p>参数是个有两个函数作为元素的数组，可以发现，第一个函数元素是打包index.js的结果，第二个是打包a.js的结果。</p> <p>在自执行函数体中，调用 <code>__webpack_require__(0)</code> 先从第一个模块开始执行，看一下第一个在第一个函数中做的事情。</p> <ol><li>先给 <code>__webpack_exports__</code> 赋值了 __esModule 属性，表面这是个es6的模块方式</li> <li>然后执行了 <code>__webpack_require__(1)</code>，引入第二个模块，并把返回的 <code>module.exports</code>结果赋值给 <code>__WEBPACK_IMPORTED_MODULE_0__a_js__</code></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__a_js__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>最后给 <code>__webpack_exports__</code>赋值default属性</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>__webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>可以发现，整个自执行函数是个 <code>__webpack_require__</code> 递归执行的过程，<strong>通过不断的向下传递 <code>__webpack_require__</code>方法，达到不断的向上传递 <code>__webpack_exports__</code>结果的目的</strong>，每一次向下传递 <code>__webpack_require__</code>方式，都会创建一个新的 <code>module</code>对象，而 <code>__webpack_exports__</code>也正是对 <code>module.exports</code>对象的引用，这也表明了 <code>__webpack_require__</code> 导入的结果和commonjs的实现方式是类似的，都是导入的一个对象。</p> <p>这部分的代码可在<a href="https://github.com/MinjieChang/module/tree/master/webpack-module" target="_blank" rel="noopener noreferrer">这里查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="webpack-和-babel-模块化的配合"><a href="#webpack-和-babel-模块化的配合" class="header-anchor">#</a> webpack 和 babel 模块化的配合</h2> <p>以上是webpack打包的结果，现在我们再看看webpack搭配上babel会把模块化编译成什么结果。配置 <code>webpack.config.js</code>文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token operator">+</span>  module<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token operator">+</span>      <span class="token punctuation">{</span>
<span class="token operator">+</span>        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
<span class="token operator">+</span>        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
<span class="token operator">+</span>        use<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>          loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
<span class="token operator">+</span>          options<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-preset-env'</span><span class="token punctuation">]</span>
<span class="token operator">+</span>          <span class="token punctuation">}</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>      <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token punctuation">]</span>
<span class="token operator">+</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>主要在 <code>module</code>部分对js文件的解析加上了 <code>babel-loader</code>，再看打包的输出结果，区别主要是在自执行函数的参数上：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token comment">/* 0 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> _a2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_a2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>

    exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 1 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// import b from './b.js'</span>

    <span class="token comment">// console.log(b)</span>

    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>可以发现，在函数中引入了babel的辅助方法 <code>_interopRequireDefault</code>，<strong>可知在webpack打包前babel已经对模块化做了编译了</strong>，并且函数的参数也是使用了 <code>exports</code> 替代了 <code>__webpack_exports__</code>，这可能是是babel处理的结果，也可能是webpack处理的结果，这么做的目的都是为了兼容babel对模块化处理的方式。</p> <p>这部分的代码可在<a href="https://github.com/MinjieChang/module/tree/master/webpack-babel-module" target="_blank" rel="noopener noreferrer">这里查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="模块依赖优化"><a href="#模块依赖优化" class="header-anchor">#</a> 模块依赖优化</h2> <h3 id="tree-shaking"><a href="#tree-shaking" class="header-anchor">#</a> tree shaking</h3> <p>webpack2开始引入 <code>tree shaking</code> 技术，对静态分析es6语法，可以删除没被使用到的模块。需要注意的是，它只对es6的模块化语法有效，一旦引入babel对模块化的处理，<code>tree-shaking</code>的功能将失效。</p> <p>1、这里先看看webpack的tree-shaking的效果：</p> <p>从a.js中导出两个变量：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span>
</code></pre></div><p>在index.js 文件中引入 a和b这两个变量，但是只使用到了a这个变量：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'index.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>webpack打包index.js得到结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token comment">/* 0 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__a_js__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__WEBPACK_IMPORTED_MODULE_0__a_js__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 1 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><p>可以发现，在导出的a.js文件中，最终只导出了变量 <code>b</code>，变量a由于在index.js中没有被使用到，最终被 <code>tree-shaking</code> 掉了。</p> <p>2、引入babel后的打包的效果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token comment">/* 0 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> _a <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> _a2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span>_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> obj <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_a2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>

    exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 1 */</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      value<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，在导出的模块中把a和b两个模块都导出了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所以要使用webpack的tree-shaking功能，并结合babel的es6转换能力，需要 <strong>在配置中关掉babel的模块转换功能</strong></p> <p>.babelrc 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>a.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span>

<span class="token operator">+</span> <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token number">111</span> <span class="token comment">// 添加内容</span>
</code></pre></div><p>最终 a.js 编译结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">/* unused harmony export a */</span>
  <span class="token comment">/* unused harmony export b */</span>
  <span class="token comment">// import b from './b.js' </span>
  <span class="token comment">// console.log(b)</span>
  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">333</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">222</span><span class="token punctuation">;</span>
  __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>最后只导出了变量 <code>a</code>。</p> <p>从上面的分析中，支持 <code>tree-shaking</code>需要满足这几个条件</p> <ol><li>tree-shaking 只对es6模块的导入导出有效，即使使用es6模块的方式引入commonjs模块的导出方式，也无法使tree-shaking生效</li> <li>模块最终导出的内容取决于导入它的文件引用了其哪些变量，webpack对此进行分析，只导出那些外部引用文件使用到的变量，并最终shaking掉那些虽然导出但是未被使用到的变量</li> <li>webpack结合babel使用，需要关闭掉babel对模块语法的转换功能，才能使tree-shaking生效</li></ol> <p>目前，大多数三方库遵循的是commonjs规范的导出(可能是使用了babel编译的结果)，所以这导致引入三方库时造成了许多不必要的变量引入</p> <p>所以对于三方库要支持tree-shaking的功能，要同时支持es6和commonjs规范的导出。对于这两种规范的导出，es6规范的入口需要在 <code>package.json</code> 中由指定 <code>module</code>字段指定，commonjs的入口还是由 <code>main</code>字段指定</p> <p>总结一下，如果开发一个三方库要支持tree-shaking，需要具备以下条件：</p> <ol><li>确保代码是es6格式，即 <code>export，import</code></li> <li><code>package.json</code> 中，设置 <code>sideEffects</code></li> <li>确保 <code>tree-shaking</code> 的函数没有副作用</li> <li><code>.babelrc</code> 中设置 <code>presets [[&quot;env&quot;, { &quot;modules&quot;: false }]]</code> 禁止转换模块，交由<code>webpack</code>进行模块化处理</li></ol> <h3 id="按需加载"><a href="#按需加载" class="header-anchor">#</a> 按需加载</h3> <p>另一种常见的模块依赖的优化方法是按需加载，通常我们加载第三方库使用 <code>require</code>或 <code>import</code>的方法引入，导入的是这个库的全量导出，但我们通常只需要使用其中的几个方法或组件，这就造成导入的很多内容是无用的，徒劳增大了文件的体积：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Button<span class="token punctuation">,</span> Form <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span>
</code></pre></div><p>由上可知，babel编译后的结果类似如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> _antd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Button <span class="token operator">=</span> _antd<span class="token punctuation">.</span>Button
<span class="token keyword">var</span> Form <span class="token operator">=</span> _antd<span class="token punctuation">.</span>Form
</code></pre></div><p><code>var _antd = require('antd')</code>这个过程已经将所有的antd的组件导入进来了。</p> <p>按需加载就是用来解决这种问题，所谓按需加载就是只引入库的部分模块，而不是整体引入。antd提供了一个插件 <code>babel-plugin-import</code>就是用来做按需加载，它会把上面引入编译成如下结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/button'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Form <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'antd/lib/form'</span><span class="token punctuation">)</span>
</code></pre></div><p>我们看到，使用按需加载后，导入路径变成了存放组件的对应的文件，只引入使用到的组件，未使用到的组件不会被加载进来，将引入量减少到最低。</p> <p>我们也看到，几乎所有组件的文件结构都是如下这种格式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">|</span><span class="token operator">-</span>lib
<span class="token operator">||</span><span class="token operator">--</span>component1
<span class="token operator">||</span><span class="token operator">--</span>component2
<span class="token operator">||</span><span class="token operator">--</span>component3
<span class="token operator">|</span><span class="token operator">-</span>index<span class="token punctuation">.</span>common<span class="token punctuation">.</span>js
</code></pre></div><p><code>index.common.js</code> 给 <code>import {xxx} from 'antd'</code> 这种导入方式提供全部组件。</p> <p>lib下存放各个单独的文件，用于提供按需加载的支持。</p> <p>总结一下，关于tree-shaking和按需加载的区别</p> <ol><li>tree-shaking 主要作用于单个的导出文件，实际导出的内容取决于被导入时引用了哪些变量，那些未被引入的变量将不被导出。这是webpack本身支持的能力。</li> <li>按需加载主要作用于引入的类库，将全量引入类库的写法改为只引入使用到的文件。这首先需要提供babel插件，同时也需要三方库提供这种按需加载的支持(例如文件的结构格式)</li></ol> <h2 id="webpack编译后再导出供三方使用"><a href="#webpack编译后再导出供三方使用" class="header-anchor">#</a> webpack编译后再导出供三方使用</h2> <p>前面提到，一些三方的库通常遵循的是commonjs的模块规范，这种方式可能是使用的babel编译的结果。当然目前打包库的方法比较多，比如rollup、browserify、gulp等，其实webpack也提供了这个能力，现在我们打包后的结果是个自执行函数，无法再被第三方导入使用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>modulesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最终是把入口文件的导出 <code>module.exports</code> 给 <code>return</code>了出去，无法再被其他模块引用。</p> <p>webpack 提供了两个属性，<code>output.libraryTarget</code>和<code>output.library</code></p> <p><code>output.libraryTarget</code>配置以何种方式导出库，<code>output.library</code>配置导出库的名称，这两者组合有这几种方式：</p> <ol><li><code>output.libraryTarget</code> 的默认值为 var，相当于导入为全局变量，如果配置 <code>output.library</code>为 <code>test</code>，通过script标签引入编译后的文件，在之后的js代码中通过library设置的变量名来引用。其实就是将输出结果挂载到 <code>test</code>这个全局变量上<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>modulesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><code>output.libraryTarget</code> 值设为 <code>commonjs</code>，编写的库将通过 <code>commonjs</code>规范导出，若设置 <code>output.library</code>为 <code>test</code>，最后导出结果为：<div class="language-js extra-class"><pre class="language-js"><code> exports<span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>modulesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><code>output.libraryTarget</code> 值设为 <code>commonjs2</code>，编写的库将通过commonjs2规范导出，此时library属性无意义，如下：<div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>modulesArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>以上就是对 <code>babel</code> 和 <code>webpack</code>关于模块化实现的解析，希望能对看到这里的读者有一点帮助吧。</p> <p>refer:</p> <p><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md" target="_blank" rel="noopener noreferrer">babel 使用文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br> <a href="https://github.com/ShowJoy-com/showjoy-blog/issues/39" target="_blank" rel="noopener noreferrer">「前端」import、require、export、module.exports 混合详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">5/11/2021, 11:19:46 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node/koa2/" class="prev">
        koa2 中间件的实现分析及实现自己的中间件组合方式
      </a></span> <span class="next"><a href="/node/babel/">
        babel 解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.73ed0f99.js" defer></script><script src="/assets/js/2.67e34e85.js" defer></script><script src="/assets/js/17.b85e52dc.js" defer></script>
  </body>
</html>
